---
- name: Initialize predeploy error list
  ansible.builtin.set_fact:
    predeploy_errors: []
  delegate_to: localhost
  run_once: true

- name: Gather LevCharity plugins
  ansible.builtin.find:
    paths: "{{ project_local_path }}/web/app/plugins"
    patterns: "levcharity*"
    file_type: directory
    recurse: false
  register: levcharity_plugin_dirs
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Detect LevCharity plugins missing built assets
  ansible.builtin.shell: |
    if [ -d "{{ item.path }}/resources" ] && [ ! -d "{{ item.path }}/assets" ]; then
      basename "{{ item.path }}"
    fi
  args:
    executable: /bin/bash
  register: levcharity_plugin_asset_checks
  changed_when: false
  when: levcharity_plugin_dirs.matched | default(0) | int > 0
  loop: "{{ levcharity_plugin_dirs.files | default([]) }}"
  loop_control:
    label: "{{ item.path | basename }}"
  delegate_to: localhost
  run_once: true

- name: Record LevCharity plugin asset failures
  ansible.builtin.set_fact:
    missing_plugin_assets: "{{ (levcharity_plugin_asset_checks.results | default([])) | map(attribute='stdout') | reject('equalto', '') | list }}"
  delegate_to: localhost
  run_once: true

- name: Collect plugin asset error message
  ansible.builtin.set_fact:
    predeploy_errors: "{{ predeploy_errors + ['Missing built assets for plugins: ' ~ (missing_plugin_assets | join(', '))] }}"
  when: missing_plugin_assets | default([]) | length > 0
  run_once: true

- name: Gather themes
  ansible.builtin.find:
    paths: "{{ project_local_path }}/web/app/themes"
    patterns: "*"
    file_type: directory
    recurse: false
  register: theme_dirs
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Detect themes missing built assets
  ansible.builtin.shell: |
    if [ -d "{{ item.path }}/resources" ] && [ ! -d "{{ item.path }}/assets" ]; then
      basename "{{ item.path }}"
    fi
  args:
    executable: /bin/bash
  register: theme_asset_checks
  changed_when: false
  when: theme_dirs.matched | default(0) | int > 0
  loop: "{{ theme_dirs.files | default([]) }}"
  loop_control:
    label: "{{ item.path | basename }}"
  delegate_to: localhost
  run_once: true

- name: Record theme asset failures
  ansible.builtin.set_fact:
    missing_theme_assets: "{{ (theme_asset_checks.results | default([])) | map(attribute='stdout') | reject('equalto', '') | list }}"
  delegate_to: localhost
  run_once: true

- name: Collect theme asset error message
  ansible.builtin.set_fact:
    predeploy_errors: "{{ predeploy_errors + ['Missing built assets for themes: ' ~ (missing_theme_assets | join(', '))] }}"
  when: missing_theme_assets | default([]) | length > 0
  run_once: true

- name: Check for React Checkout lc directory
  ansible.builtin.stat:
    path: "{{ project_local_path }}/web/lc"
  register: lc_dir
  delegate_to: localhost
  run_once: true

- name: Ensure lc/checkout exists when lc directory present
  ansible.builtin.stat:
    path: "{{ project_local_path }}/web/lc/checkout"
  register: lc_checkout_dir
  when: lc_dir.stat.exists
  delegate_to: localhost
  run_once: true

- name: Fail when lc directory is missing checkout
  ansible.builtin.set_fact:
    predeploy_errors: "{{ predeploy_errors + ['Found React Checkout repo, but missing required \"checkout\" subdirectory.'] }}"
  when:
    - lc_dir.stat.exists
    - not lc_checkout_dir.stat.exists
  run_once: true

- name: Fail when predeploy errors exist
  ansible.builtin.fail:
    msg: |-
      Pre-deploy validation failed: {{ predeploy_errors | join(', ') }}
  when: predeploy_errors | length > 0
  run_once: true