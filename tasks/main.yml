---
- name: Initialize predeploy error list
  ansible.builtin.set_fact:
    predeploy_errors: []
  delegate_to: localhost
  run_once: true

- name: Define plugins excluded from asset checks
  ansible.builtin.set_fact:
    excluded_plugins:
      - levcharity-constant-contact
      - levcharity-debugger
      - levcharity-gravityform-product
      - levcharity-jira
      - levcharity-raisers-edge-nxt
      - levcharity-receipts
      - levcharity-salesforce
  delegate_to: localhost
  run_once: true

- name: Gather LevCharity plugins
  ansible.builtin.find:
    paths: "{{ project_local_path }}/web/app/plugins"
    patterns: "levcharity*"
    file_type: directory
    recurse: false
  register: levcharity_plugin_dirs
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Detect LevCharity plugins missing built assets
  ansible.builtin.shell: |
    plugin_name=$(basename "{{ item.path }}")
    if [ -d "{{ item.path }}/resources" ] && [ -d "{{ item.path }}/resources/scripts" ] && [ ! -d "{{ item.path }}/assets" ]; then
      echo "$plugin_name"
    fi
  args:
    executable: /bin/bash
  register: levcharity_plugin_asset_checks
  changed_when: false
  when:
    - levcharity_plugin_dirs.matched | default(0) | int > 0
    - (item.path | basename) not in excluded_plugins
  loop: "{{ levcharity_plugin_dirs.files | default([]) }}"
  loop_control:
    label: "{{ item.path | basename }}"
  delegate_to: localhost
  run_once: true

- name: Record LevCharity plugin asset failures
  ansible.builtin.set_fact:
    missing_plugin_assets: "{{ (levcharity_plugin_asset_checks.results | default([])) | map(attribute='stdout') | reject('equalto', '') | list }}"
  delegate_to: localhost
  run_once: true

- name: Collect plugin asset error message
  ansible.builtin.set_fact:
    predeploy_errors: "{{ predeploy_errors + ['Missing built assets for plugins: ' ~ (missing_plugin_assets | join(', '))] }}"
  when: missing_plugin_assets | default([]) | length > 0
  run_once: true

- name: Gather themes
  ansible.builtin.find:
    paths: "{{ project_local_path }}/web/app/themes"
    patterns: "*"
    file_type: directory
    recurse: false
  register: theme_dirs
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Detect themes missing built assets
  ansible.builtin.shell: |
    if [ -d "{{ item.path }}/resources" ] && [ ! -d "{{ item.path }}/assets" ]; then
      echo "$(basename "{{ item.path }}")"
    fi
  args:
    executable: /bin/bash
  register: theme_asset_checks
  changed_when: false
  when: theme_dirs.matched | default(0) | int > 0
  loop: "{{ theme_dirs.files | default([]) }}"
  loop_control:
    label: "{{ item.path | basename }}"
  delegate_to: localhost
  run_once: true

- name: Record theme asset failures
  ansible.builtin.set_fact:
    missing_theme_assets: "{{ (theme_asset_checks.results | default([]) | selectattr('stdout', 'defined') | selectattr('stdout', '!=', '') | map(attribute='stdout') | list) }}"
  delegate_to: localhost
  run_once: true

- name: Collect theme asset error message
  ansible.builtin.set_fact:
    predeploy_errors: "{{ predeploy_errors + ['Missing built assets for themes: ' ~ (missing_theme_assets | join(', '))] }}"
  when: missing_theme_assets | default([]) | length > 0
  run_once: true

- name: Fail when predeploy errors exist
  ansible.builtin.fail:
    msg: |-
      Pre-deploy validation failed: {{ predeploy_errors | join(', ') }}
  when: predeploy_errors | length > 0
  run_once: true
